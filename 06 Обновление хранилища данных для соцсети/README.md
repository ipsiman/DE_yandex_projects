# Проектная работа по организации Data Lake

Соцсеть, для которой мы построили Data Lake, развивается — пробный запуск в Австралии оказался удачным. Команда готовится к разработке обновлений. Значит, структуру хранилища предстоит переделать, а данные — дополнить. Этим мы и займётесь в проекте.

## Описание задачи
Коллеги из другого проекта по просьбе вашей команды начали вычислять координаты событий (сообщений, подписок, реакций, регистраций), которые совершили пользователи соцсети. Значения координат будут появляться в таблице событий. Пока определяется геопозиция только исходящих сообщений, но уже сейчас можно начать разрабатывать новый функционал. 

В продукт планируют внедрить систему рекомендации друзей. Приложение будет предлагать пользователю написать человеку, если пользователь и адресат:
- состоят в одном канале,
- раньше никогда не переписывались,
- находятся не дальше 1 км друг от друга.

При этом команда хочет лучше изучить аудиторию соцсети, чтобы в будущем запустить монетизацию. Для этого было решено провести геоаналитику:
- Выяснить, где находится большинство пользователей по количеству сообщений, лайков и подписок из одной точки.
- Посмотреть, в какой точке Австралии регистрируется больше всего новых пользователей.
- Определить, как часто пользователи путешествуют, и какие города выбирают.

Благодаря такой аналитике в соцсеть можно будет вставить рекламу: приложение сможет учитывать местонахождение пользователя и предлагать тому подходящие услуги компаний-партнёров. 

## Шаги по выполнению проекта

### Шаг 1. Обновить структуру Data Lake
Новые данные событий из RAW (слой сырых данных) слоя `/user/master/data/geo/events` перенесем в ODD слой `/user/ipsiman/data/geo/events` где данные будут тестироваться. Т.к. данные уже в нужном формате `.parquet` и партицированы по датам, то просто перенесем их без изменений.

Таблицу с координатами городов из файла `geo.csv` сохраним в папке `/user/ipsiman/data/geo/city_geo` ODD слоя.

Для аналитиков и витрин будет использоваться Data Sandbox - `/user/ipsiman/data/analytics`. После проверки и утверждения нужных витрин их можно отправить в прод в слой DML `/user/prod/data`.

Данные будем догружать/обновлять один раз в день. Формат для данных будем использовать `.parquet`.

### Шаг 2. Создать витрину в разрезе пользователей
1. Определить, в каком городе было совершено событие. С этим поможет список городов из файла geo.csv. В нём указаны координаты центра города. 
Найти расстояние от координаты отправленного сообщения до центра города. Событие относится к тому городу, расстояние до которого наименьшее.
2. После вычисления геопозиции каждого отправленного сообщения, создать витрину с тремя полями:
- `user_id` — идентификатор пользователя.
- `act_city` — актуальный адрес. Это город, из которого было отправлено последнее сообщение.
- `home_city` — домашний адрес. Это последний город, в котором пользователь был дольше 27 дней.
3. Выяснить, сколько пользователь путешествует. Добавить в витрину два поля:
- `travel_count` — количество посещённых городов. Если пользователь побывал в каком-то городе повторно, то это считается за отдельное посещение.
- `travel_array` — список городов в порядке посещения.
4. Добавить в витрину последний атрибут — местное время (local_time) события (сообщения или других событий, если вы их разметите на основе сообщений). Местное время события — время последнего события пользователя, о котором у нас есть данные с учётом таймзоны геопозиции этого события. Данные, которые вам при этом пригодятся:
- `TIME_UTC` — время в таблице событий. Указано в UTC+0.
- `timezone` — актуальный адрес. Атрибуты содержатся в виде Australia/Sydney.

### Шаг 3. Создать витрину в разрезе зон
Создать геослой — найти распределение атрибутов, связанных с событиями, по географическим зонам (городам). Если проанализировать этот слой, то можно понять поведение пользователей по различным регионам. 
Нужно посчитать количество событий в конкретном городе за неделю и месяц. Значит, витрина будет содержать следующие поля:
- `month` — месяц расчёта;
- `week` — неделя расчёта;
- `zone_id` — идентификатор зоны (города);
- `week_message` — количество сообщений за неделю;
- `week_reaction` — количество реакций за неделю;
- `week_subscription` — количество подписок за неделю;
- `week_user` — количество регистраций за неделю;
- `month_message` — количество сообщений за месяц;
- `month_reaction` — количество реакций за месяц;
- `month_subscription` — количество подписок за месяц;
- `month_user` — количество регистраций за месяц.

### Шаг 4. Построить витрину для рекомендации друзей
Напомним, как будет работать рекомендация друзей: если пользователи подписаны на один канал, ранее никогда не переписывались и расстояние между ними не превышает 1 км, то им обоим будет предложено добавить другого в друзья. Образовывается парный атрибут, который обязан быть уникальным: порядок упоминания не должен создавать дубли пар.
Витрина будет содержать следующие атрибуты:
- `user_left` — первый пользователь;
- `user_right` — второй пользователь;
- `processed_dttm` — дата расчёта витрины;
- `zone_id` — идентификатор зоны (города);
- `local_time` — локальное время.

### Шаг 5. Автоматизировать обновление витрин
С помощью Airflow автоматизировать все три скрипта, которые написали для построения витрин.